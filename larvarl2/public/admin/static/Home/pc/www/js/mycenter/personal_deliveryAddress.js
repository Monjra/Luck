LT.namespace("LT.personal_deliveryAddress"),LT.personal_deliveryAddress=function(){var e,t,a=LT.Form.Config,i=($(".J_table tbody"),$(".per_right")),d=!1,s={province:"getProvince.php",city:window.ControllerSite+"/MyCenter/getCity?provinceid=",area:window.ControllerSite+"/MyCenter/getCountry?cityid="};t={bindEvent:function(){t._setSelect({that:i.find(".J_province"),nextELe:i.find(".J_city"),lastEle:i.find(".J_area"),url:s.province}),$("#btn_SaveAddress").click(function(){if($("#btn_SaveAddress").hasClass("masked"))return!1;$("#btn_SaveAddress").addClass("relative"),$("#btn_SaveAddress").mask(),$("#hid_area").val($(".J_area").getValue());var e=!0,a=$("#formAddress");if(t._validate(a),$(".J_area").next().remove(),"--请选择--"==$(".J_area .sel_span").html()&&($(".J_area").after('<div class="onblurtext_w"><div class="form_error_panel"><div class="form_error_arrow form_error_arrow_bottom"><div class="line1"></div><div class="line2"></div><div class="line3"></div><div class="line4"></div><div class="line5"></div><div class="line6"></div><div class="line7"></div><div class="line8"></div><div class="line9"></div><div class="line10"></div></div><div class="form_error_content">请选择省市区</div></div></div>'),e=!1),a.valid()){var i=a.serialize(),d="0";$(".J_default_address").hasClass("checked")&&(d="1"),e&&$.post(window.ControllerSite+"/MyCenter/SaveAddress",i+"&isdefault="+d,function(e){$("#btn_SaveAddress").unmask(),1==e.success?LT.alertSmall("添加成功",function(){window.location.href=window.ControllerSite+"MyAddressManager.html"}):LT.alertSmall("参数错误，添加失败")})}e||$(".J_area").next().show()}),$(document).delegate(".J_edit","click",function(e){var a=this,i=$(a).parent("td").siblings("td.J_td2"),n=($(a).parent("td").siblings("td.J_td"),[]),r=[];i.each(function(){n.push($.trim($(this).html()))}),$(a).parents("tr").find(".J_td3 input").each(function(){r.push({value:$(this).val(),text:$(this).attr("data-text")})});var l='<form id="form1" method="post" action="/www.biyao.com/MyCenter/SaveAddress"><div class="pd_t20 pd_b10"><input type="hidden" name="area" id="hid_area" class="J_hide" ><table class="per_table"><tr><th width="15%"><span class="col_ee5b47 mg_r10"></span>收货人姓名：</th><td width="63%"><input maxlength=64 type="text" class="inpCom w200 permy" name="receiver" value="'+n[0]+'" data-highlight="highlight" /></td><td width=""></td></tr><tr><th><span class="col_ee5b47 mg_r10"></span>省市：</th><td colspan="2"> ';l+='<div class="J_province w120 mg_r10 posR f_l permy" id="province"><input type="hidden" name="province" id="hid_province" class="J_hide" value="'+r[0].value+'" data-text='+r[0].text+" /></div>",l+='<div class="J_city w120 mg_r10 posR f_l permy" id="city"><input type="hidden" name="city" id="hid_city" class="J_hide"  value="'+r[1].value+'" data-text='+r[1].text+"></div>",l+='<div class="J_area w140 f_l posR permy permyre updateareas" id="area"></div>',l+='</td></tr><tr><th><span class="col_ee5b47 mg_r10"></span>街道地址：</th><td><input class="inpCom w380 permy" maxlength=128  type="text" name="address"  value="'+n[1]+'" data-highlight="highlight" /></td><td></td></tr><tr><th><span class="col_ee5b47 mg_r10"></span>手机号码：</th><td><input maxlength=64 type="text" class="inpCom w200 permy" name="phone" value="'+n[2]+'" data-highlight="highlight" /></td><td></td></tr><tr><tr><th></th><td><label class="J_default_address"><i class="openIcon inline "></i>&nbsp;设为默认地址</label></td><td></td></tr></table></div></form>',$(this).dialogFn({title:"修改收货地址",type:"confirm",height:"",width:"733px",content:l,fixed:!1,btnText:["确 定","取 消"],showAfter:function(){obj1=this.id,$(".J_default_address").addClass("checked"),t._setSelect({that:this.id.find(".J_province"),nextELe:this.id.find(".J_city"),lastEle:this.id.find(".J_area"),url:s.province,init:!0}),this.id.find(".J_province").setValue(r[0].value),t._setSelect({that:this.id.find(".J_city"),url:s.city+r[0].value}),this.id.find(".J_city").setValue(r[1].value),t._setSelect({that:this.id.find(".J_area"),url:s.area+r[1].value}),this.id.find(".J_area").setValue(r[2].value)},callback:function(e){if(1==e){var i=this.id.find("form");t._validate(i),this.id.find("#hid_area").val(this.id.find(".J_area").getValue()),i.submit(),$(".updateareas").next().remove();var s=!0;if("--请选择--"==i.find(".J_area .sel_span").html()&&($(".updateareas").after('<div class="form_error_content" style="color:#EE5B47">&nbsp;&nbsp;&nbsp;请选择省市区</div>'),s=!1),!i.valid())return!0;if(!s)return!0;$(".J_td").attr("type","false"),i.find(".J_default_address").hasClass("checked")&&(d=!0),r.length=0,i.find(".J_select").next("input").each(function(){r.push({value:$(this).val(),text:$(this).attr("data-text")})}),t._SubmittingForm(i,$(a).parents("tr"),r,"true")}}}),e.preventDefault()}),$(document).delegate(".J_dele","click",function(e){var t=$(this);t.dialogFn({title:"提示",type:"confirm",className:"w60",width:"300px",content:"</br><p>&nbsp;&nbsp;&nbsp;亲，确定要删除这个地址吗？</p></br>",callback:function(a){if(a){var i=t,d=i.parents("tr");data={addressId:d.data("addressid")},$.ajax({url:window.ControllerSite+"/MyCenter/DeleteAddress",dataType:"json",type:"POST",data:data,success:function(e){1==e.success&&d.remove()},error:function(){},complete:function(){}}),e.preventDefault()}}})})},_SubmittingForm:function(e,t,a,i){void 0==i&&(d="checked"==e.find('input[name="isdefault"]').attr("checked")?!0:!1);var s=e.attr("action"),n=e.find('input[name="receiver"]'),r=e.find('input[name="phone"]'),l=e.find('input[name="address"]'),c=e.find('input[name="province"]'),o=e.find('input[name="city"]'),v=e.find('input[name="area"]'),h=$.trim(c.attr("data-text")+o.attr("data-text")+v.attr("data-text")),u={receiver:n.val(),phone:r.val(),address:l.val(),add2:h,areaId:v.val(),zipcode:"000000",isdefault:d?1:0,isUpdate:1},_=" ";t.data("addressid")&&(u.addressId=t.data("addressid")),$.ajax({url:s,dataType:"json",type:"POST",data:u,success:function(i){1==i.success&&("TBODY"==$(t)[0].tagName&&(t.prepend('<tr data-addressid="'+i.data+'"><td class="J_td2">'+u.name+'</td><td class="J_td3">'+u.add2+'<input type="hidden"  value="'+a[0].value+'" data-text="'+a[0].text+'" /><input type="hidden" value="'+a[1].value+'" data-text="'+a[1].text+'" /><input type="hidden" value="'+a[2].value+'" data-text="'+a[2].text+'" /></td><td align="left" class="J_td2">'+u.add+'</td><td class="J_td2">'+u.mobile+'</td><td class="J_td2">'+u.postcode+'</td><td class="J_td">'+_+'</td><td><a href="#" class="J_edit">修改</a> / <a href="#" class="J_dele">删除</a></td></tr>'),1==d&&($(t).find(".J_td").removeAttr("type","").html(""),$(t).find(".J_td").eq(0).attr("type","true").html('<span class="col_ee5b47">默认地址</span>'),d=!1),n.val(""),r.val(""),l.val(""),oPost.val(""),c.val("").removeAttr("data-text"),o.val("").removeAttr("data-text"),v.val("").removeAttr("data-text"),e.find(".J_province").setValue(" "),e.find(".J_city").setValue(" "),e.find(".J_city li[data-hover]").slice(1).remove(),e.find(".J_area").setValue(" "),e.find(".J_area li[data-hover]").slice(1).remove(),$(".sel_p").each(function(e){e>0&&$(this).html("")}),$("span.correct").remove(),$("label").remove()),window.location.reload())},error:function(){}})},_validate:function(e){e.validate({submitHandler:function(){return!1},rules:{receiver:{required:!0},address:{required:!0,maxlength:30},phone:{required:!0,mobile:!0},zipcode:{number:!0,maxlength:6,minlength:6}},messages:{receiver:{required:"名字还没写"},address:{required:"详细地址还没写呢",maxlength:"最多只能输入30个字符"},phone:{required:"手机号码不能为空",mobile:a.Text("手机")},province:{required:a.Required},city:{required:a.Required},addr_area_id:{required:a.Required},zipcode:{number:"格式不正确",maxlength:"格式不正确",minlength:"格式不正确"}}})},_selectShow:function(e,t){var a=$(e.target),i=a.attr("value"),d=t.children("span").attr("value");return a.hasClass("hovername")?(a.attr("check","true").siblings().removeAttr("check"),i==d?!1:(t.children("span").html(a.html()).attr("value",i),i)):!1},_setSelect:function(e){$.ajax({url:e.url,dataType:"json",type:"get",async:!1,success:function(a){e.that&&0!=e.that.length&&e.that.selectFn({data:a.data,textField:"addr_name",valueField:"addr_id",maxRow:10,change:function(){t._cheakInputVal(this.that.find("input"),this.value,this.text),this.that.nextAll("div").setValue(""),t._setSelect({that:this.that.next(".J_city"),url:s.city+this.value}),t._setSelect({that:this.that.nextAll(".J_area"),url:s.area})}}),e.nextELe&&0!=e.nextELe.length&&e.nextELe.selectFn({maxRow:10,textField:"addr_name",valueField:"addr_id",change:function(){t._cheakInputVal(this.that.find("input"),this.value,this.text),this.that.next("div").setValue(""),t._setSelect({that:this.that.next(".J_area"),url:s.area+this.value})}}),e.nextELe&&0!=e.nextELe.length&&e.lastEle.selectFn({maxRow:10,textField:"addr_name",valueField:"addr_id",change:function(){"--请选择--"==this.text?$(".J_area").after('<div class="form_error_panel"><div class="form_error_arrow form_error_arrow_bottom"><div class="line1"></div><div class="line2"></div><div class="line3"></div><div class="line4"></div><div class="line5"></div><div class="line6"></div><div class="line7"></div><div class="line8"></div><div class="line9"></div><div class="line10"></div></div><div class="form_error_content">请选择省市区</div></div>'):$(".J_area").next().remove(),t._cheakInputVal(this.that.find("input"),this.value,this.text)}}),e.that.hasClass("J_province")&&e.that.setOptions(a),e.that.hasClass("J_city")&&e.that.setOptions(a),e.that.hasClass("J_area")&&e.that.setOptions(a)},error:function(){}})},_cheakInputVal:function(e,t,a){""!=t?e.val(t).attr("data-text",a).next().hide():e.val("").attr("data-text","").next().show()}},e=function(){for(var e in t)-1==e.indexOf("_")&&t[e]()}()},$(function(){LT.personal_deliveryAddress()});