function settlementCheck(){$("input[name='quantity']").each(function(){if(cacheSubmit){var a=$(this),e=a.attr("num"),t=a.val(),s=parseInt(t),c=/^\+?[1-9][0-9]*$/;if(a.parent().find("p[class='col_b76 mg_t5']").html(""),0==t)return LT.alertSmall("单件商品数不得小于1!"),void a.val(e);if(!c.test(t)||t.indexOf(".")>0)return LT.alertSmall("商品数量存在非法字符!"),void a.val(e);if(s>999)return LT.alertSmall("单件商品数量不得大于999!"),void a.val(e);if(1>s)return LT.alertSmall("单件商品数不得小于1!"),void a.val(e);if(parseInt(a.attr("num"))!=s&&changeNumCheck(a),"checked checkbox chk_Calc"==a.parent().siblings().eq(0).find("label").attr("class")){a.attr("num",t);var n=updateByShopCarId(a,s);if(205017==n.success)return LT.alertSmall("非常抱歉,所选商品包含原材料不足商品,请重新选择!"),a.parent().find("p[class='col_b76 mg_t5']").html("原材料不足"),void(cacheSubmit=!1);n.success?calcTotal():(a.val(e),a.attr("num",e),LT.alertSmall("购买失败,请重试!"))}}})}function ischeckedbox(){$(".shoppingBox").each(function(){var a=$(this);a.find(".tabledel").find(".chk_Calc").each(function(){var e=$(this);return e.hasClass("checked")?void a.find(".divdel").find(".checkbox").addClass("checked"):(a.find(".divdel").find(".checkbox").removeClass("checked"),!1)})}),$(".chk_Calc").each(function(){return $(this).hasClass("checked")?void $("label[name='chkAll']").addClass("checked"):($("label[name='chkAll']").removeClass("checked"),!1)})}$(function(){$(".pack_select").bind("click",function(){var a=$(this).find(".sel_div");return $(".sel_div").addClass("none"),a.removeClass("none"),!1}),$(".package_radio").bind("click",function(){var a=$(this).parent().parent();a.find(".package_radio").removeClass("checked"),$(this).addClass("checked")}),$(".pack_sdiv li").bind("click",function(){var a=$(this).attr("data-value"),e=$(this).attr("data-carid"),t=updatePackage(e,a);if(t.success){var s=$(this),c=s.find(".PackageType").text(),n=s.find(".PackagePrice").text();return s.parent().parent().addClass("none"),calcTotal(),s.parent().find("li").removeClass("hovername"),s.addClass("hovername"),s.find(".PackageType").text(),s.find(".PackagePrice").text(),s.parents(".pack_select").find(".span_package_type").html(c),s.parents(".pack_select").find(".span_package_price").html("0"==n?"(免费)":"&nbsp;¥"+n),!1}LT.alertSmall("包装信息修改失败")}),$("body").click(function(){$(".sel_div").addClass("none")}),$(".shoppingBox ").find("[name='btnShare']").click(function(a){LT.generateShareLayer.call(this),a.preventDefault()}),$(".msgBtn").bind("click",function(){var a=$(this),e=a.attr("dataid");if(2==a.attr("datatype")){var t="#preSaleDiv"+e,s=parseFloat(a.attr("dataprice"));$("td[name='promotionPrice']").each(function(){var a=$(this),e=a.attr("discount");a.html(s*parseFloat(e)/100)}),$(t).show(),$(t+" .pop_close,#iknow").unbind("click").bind("click",function(){$(t).hide()})}else{var c="#sharePromotion"+e;$(c).show(),$(c+" .pop_close").unbind("click").bind("click",function(){$(c).hide()})}})}),$(".minus").live("click",function(){var a=$(this).next();$(this).attr("disabled","disabled");var e=parseInt(a.attr("num"));if(1>=e)return LT.alertSmall("不能再减了，再减就没了"),a.val(1),void $(this).removeAttr("disabled");changeNumCheck(a),a.attr("num",e-1),a.val(e-1);var t=updateByShopCarId(a,e-1);if(205017==t.success)calcTotal();else if(t.success){var s=a.parent().parent().find("td[class='ff6600']").html(),c=s.toString().substring(1),n=c*a.val();a.parent().parent().find("td[width='10%']").find("strong[class='ff6600']").html("¥"+n),calcTotal()}else{a.attr("num",e),a.val(e);var s=a.parent().parent().find("td[class='ff6600']").html(),c=s.toString().substring(1),n=c*a.val();a.parent().parent().find("td[width='10%']").find("strong[class='ff6600']").html("¥"+n),LT.alertSmall("更改数量失败,请重试")}$(this).removeAttr("disabled")}),$(".plus").live("click",function(){var a=$(this).prev();$(this).attr("disabled","disabled");var e=parseInt(a.attr("num"));if(e>=999)return LT.alertSmall("当前商品数量最大值为999"),void $(this).removeAttr("disabled");changeNumCheck(a);var t=updateByShopCarId(a,e+1);if(205017==t.success)LT.alertSmall("当前商品原材料不足,增加数量失败");else if(t.success){a.attr("num",e+1),a.val(e+1);var s=a.parent().parent().find("td[class='ff6600']").html(),c=s.toString().substring(1),n=c*a.val();a.parent().parent().find("td[width='10%']").find("strong[class='ff6600']").html("¥"+n),calcTotal()}else a.attr("num",e),a.val(e),LT.alertSmall("更改数量失败,请重试");$(this).removeAttr("disabled")});var cacheSubmit=!0;$("input[name='quantity']").live("blur",function(){var a=$(this),e=a.attr("num"),t=a.val(),s=parseInt(t),c=/^\+?[1-9][0-9]*$/;if(a.parent().find("p[class='col_b76 mg_t5']").html(""),0==t)return LT.alertSmall("单件商品数不得小于1!"),void a.val(e);if(!c.test(t)||t.indexOf(".")>0)return LT.alertSmall("商品数量存在非法字符!"),void a.val(e);if(s>999)return LT.alertSmall("单件商品数量不得大于999!"),void a.val(e);if(1>s)return LT.alertSmall("单件商品数不得小于1!"),void a.val(e);if(parseInt(a.attr("num"))!=s&&changeNumCheck(a),"checked checkbox chk_Calc"==a.parent().siblings().eq(0).find("label").attr("class")){a.attr("num",t);var n=updateByShopCarId(a,s);if(205017==n.success)return a.parent().find("p[class='col_b76 mg_t5']").html("原材料不足"),void(cacheSubmit=!1);n.success?calcTotal():(a.val(e),a.attr("num",e),LT.alertSmall("更改数量失败,请重试"))}}),$(".a_delete").live("click",function(){var a=this;LT.confirmSmall("您是否要从购物车中移除所选的商品？",function(e){if(1==e){if($(a).hasClass("masked"))return!1;$(a).addClass("relative"),$(a).mask();var t=($(a).parent().parent(),$(a).attr("data")),s=deleteByIds(t,$(a));s.success?call():LT.alertSmall("删除失败,请重试")}})}),$("label[name='chkAll']").click(function(){var a=$(this).hasClass("checked");a?$(".checkbox").removeClass("checked"):$(".checkbox").addClass("checked"),calcTotal()}),$("label[name='chk_Supplier']").live("click",function(){var a=$(this).hasClass("checked"),e=$(this).attr("data-value");a?($(this).removeClass("checked"),$("label[name='chk_"+e+"']").removeClass("checked")):($(this).addClass("checked"),$("label[name='chk_"+e+"']").addClass("checked")),ischeckedbox(),calcTotal()}),$(".chk_Calc").live("click",function(){{var a=$(this).hasClass("checked");$(this).attr("supplierId")}a?$(this).removeClass("checked"):$(this).addClass("checked"),ischeckedbox(),calcTotal()}),$(".span_submit_calre,.span_calre").click(function(){if(cacheSubmit=!0,settlementCheck(),cacheSubmit){if(!LT.temp.loginFn.islogin_dialog(!0))return;var a=0,e="",t="",s="";if($(".chk_Calc").each(function(){$(this).hasClass("checked")&&(e+=$(this).attr("data-value")+",",t+=$(this).attr("data-design")+",",s+=$(this).attr("data-num")+",",a++)}),""==e)return void LT.alertSmall("请选择要结算的商品");if(a>50)return void LT.alertSmall("一次提交结算的商品数量不能超过50个");updatePayStatus(e.substring(0,e.length-1),t.substring(0,t.length-1),s.substring(0,s.length-1))}}),$("#a_BatchDel").click(function(){var a=getCheckBoxLength();return 0==a?void LT.alertSmall("请选择要删除的商品"):void LT.confirmSmall("您是否要从购物车中移除所选的商品？",function(a){if(1==a){if($("#a_BatchDel").hasClass("masked"))return!1;$("#a_BatchDel").addClass("relative"),$("#a_BatchDel").mask();var e="";$(".chk_Calc").each(function(){if($(this).hasClass("checked")){var a=$(this);e+=a.attr("data-value")+",",$(this).parent().parent().remove()}});var t=deleteByIds(e,$("#a_BatchDel"));t.success&&call()}})});var updateByShopCarId=function(a,e){var t=a.attr("shopcarid"),c=a.attr("sizename");startIndex=c.indexOf("：")+1,s=c.substring(startIndex);var n={success:!1},l={shopCarId:t,num:e,suId:a.attr("designid"),sizeno:s};return $.ajax({type:"post",url:window.basePath+"/shopcars/ModifyGoodsNum",data:l,async:!1,dataType:"json",success:function(a){n.success=a.success},error:function(a){}}),n},updatePayStatus=function(a){var e={shopCarIds:a};$.ajax({type:"POST",url:window.basePath+"/shopcars/PrepareGotoOrder",data:e,async:!1,success:function(a){return 205017==a.success?void LT.alertSmall("非常抱歉，所选商品包含原材料不足商品，请重新选择！",function(){window.location.reload()}):220001==a.success?void LT.alertSmall("F码无效，请核对后重新输入"):220002==a.success?void LT.alertSmall("F码已失效"):220003==a.success?void LT.alertSmall("F码已失效"):230001==a.success?void LT.alertSmall("非常抱歉，您选购的部分商品原材料不足，无法购买，请返回购物车修改"):1e5==a.success?void LT.alertSmall("系统异常"):a.success?void(window.location.href="http://buy.biyao.com/orders/confirmOrderByShopCar"):void LT.alertSmall("提交结算失败,请重试")},dataType:"json"})},deleteByIds=function(a,e){var t={success:!1},s={shopCarIds:a};return $.ajax({type:"post",url:window.basePath+"/shopcar/DeleteGoods",data:s,async:!1,dataType:"json",success:function(a){e&&e.unmask(),t.success=a.success}}),t},call=function(){window.location.reload(!0)},calcTotal=function(){var a=0,e=0,t=0,s=0,c="";$(".chk_Calc").each(function(){$(this).hasClass("checked")&&(c+=$(this).attr("data-value")+",")});var n=[],l={shopcarIds:""!=c?c.substring(0,c.length-1):""};$.ajax({type:"POST",url:window.basePath+"/shopcars/GetCheckedInfo",data:l,async:!1,dataType:"json",success:function(a){n=a.data.list}}),$(".chk_Calc").each(function(){if($(this).hasClass("checked")){var c=$(this).parent().parent().find("td[class='sizeZero']").find("input[class='inpCom w40 inline t_c']"),l=c.parent().parent().find("td[class='ff6600']").html(),i=l.toString().substring(1),r=i*c.val();c.parent().parent().find("td[width='10%']").find("strong[class='ff6600']").html("¥"+r);for(var d=$(this).attr("data-value"),o=0;o<n.length;o++){var h=n[o];if(d==h.shopCar.shopCarId){var u=$("input[name='input_"+d+"']"),p=parseFloat(h.price),f=parseFloat(h.packagePrice),v=parseInt(h.shopCar.num);a+=h.allPrice,t+=v,s+=f*v;var m=parseInt(h.discount);e+=0==m?p*v:p*m*v/100;var k=h.packageType;calTotalByTxt(u,p,f,v,k)}}}}),$(".jsjs").each(function(){$(this).html("¥ "+a.toFixed(0)),document.getElementById("totalPrice").innerHTML="¥"+e.toFixed(0),document.getElementById("totalNum").innerHTML=t,document.getElementById("packagePrice").innerHTML="¥"+s.toFixed(0)})},calTotalByTxt=function(a,e,t,s,c){var n=a.parent().next(),l=t*s;l>0?(n.find(".span_package_type").html(c),n.find(".span_package_price").addClass("col_f60").html("&nbsp;¥"+l.toFixed(0))):(n.find(".span_package_type").html(c),n.find(".span_package_price").removeClass("col_f60").html("(免费)")),a.parent().prev().html("¥"+e.toFixed(0));var i=(e+t)*s;n=a.parent().next().next(),n.html("<strong class='ff6600'>¥"+i.toFixed(0)+"</strong>")},afterDel=function(){$(".order_title").each(function(){var a=$(this).attr("supplierId"),e=$("table[name='tab_"+a+"']");0==e.find("tr").length&&($(this).remove(),$("div[name='divContent_"+a+"']").remove())});var a=$(".order_title").length;0==a?window.location.href=window.location.href:calcTotal()},getCheckBoxLength=function(){var a=0;return $(".chk_Calc").each(function(){$(this).hasClass("checked")&&a++}),a},changeNumCheck=function(a){var e=a.parent().parent();e.find(".chk_Calc").addClass("checked")},updatePackage=function(a,e){var t={shopCarId:a,packageId:e},s={success:!1};return $.ajax({type:"POST",url:window.basePath+"/shopcar/ModifyPackageInfo",data:t,async:!1,dataType:"json",success:function(a){s.success=a.success}}),s};$(document).ready(function(){$.cookie("DZLOGIN")?($("#loginTip").show(),$("#unloginTip").hide()):($("#loginTip").hide(),$("#unloginTip").show())});